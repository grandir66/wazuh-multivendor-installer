<!-- Synology Rules - JSON Format -->

<group name="synology,fileserver,">

  <!-- Base rules for each log type -->
  <rule id="100120" level="3">
    <decoded_as>json</decoded_as>
    <field name="integration">synology</field>
    <field name="synology.type">connection</field>
    <description>Synology: Connection - $(synology.user)@$(synology.srcip) → $(synology.share) via $(synology.protocol)</description>
    <group>synology_connection,</group>
  </rule>

  <rule id="100140" level="3">
    <decoded_as>json</decoded_as>
    <field name="integration">synology</field>
    <field name="synology.type">winfile</field>
    <description>Synology: WinFile $(synology.action) - $(synology.user)@$(synology.srcip) → $(synology.path)</description>
    <group>synology_winfile,</group>
  </rule>

  <rule id="100130" level="3">
    <decoded_as>json</decoded_as>
    <field name="integration">synology</field>
    <field name="synology.type">filestation</field>
    <description>Synology: FileStation $(synology.action) - $(synology.user)@$(synology.srcip) → $(synology.path)</description>
    <group>synology_filestation,</group>
  </rule>

  <!-- Protocol-specific alerts -->
  <rule id="100145" level="5">
    <if_sid>100120</if_sid>
    <field name="synology.protocol">SMB1</field>
    <description>Synology: SMB1 (INSECURE!) - $(synology.user)@$(synology.srcip) → $(synology.share)</description>
    <group>smb_access,smb1,security_risk,</group>
  </rule>

  <rule id="100146" level="4">
    <if_sid>100120</if_sid>
    <field name="synology.protocol">SMB2</field>
    <description>Synology: SMB2 - $(synology.user)@$(synology.srcip) → $(synology.share)</description>
    <group>smb_access,smb2,</group>
  </rule>

  <rule id="100147" level="3">
    <if_sid>100120</if_sid>
    <field name="synology.protocol">^CIFS\(SMB3\)$|^SMB3$</field>
    <description>Synology: SMB3 - $(synology.user)@$(synology.srcip) → $(synology.share)</description>
    <group>smb_access,smb3,</group>
  </rule>

  <!-- File operation alerts -->
  <rule id="100150" level="4">
    <if_sid>100140</if_sid>
    <field name="synology.action">write|create|upload</field>
    <description>Synology: File WRITE - $(synology.user)@$(synology.srcip) → $(synology.path)</description>
    <group>file_write,data_modification,</group>
  </rule>

  <rule id="100151" level="6">
    <if_sid>100140</if_sid>
    <field name="synology.action">delete</field>
    <description>Synology: File DELETE - $(synology.user)@$(synology.srcip) → $(synology.path)</description>
    <group>file_delete,data_loss,</group>
  </rule>

  <rule id="100152" level="3">
    <if_sid>100140</if_sid>
    <field name="synology.action">read</field>
    <description>Synology: File READ - $(synology.user)@$(synology.srcip) → $(synology.path)</description>
    <group>file_read,</group>
  </rule>

  <!-- Time-based alerts -->
  <rule id="100172" level="6">
    <if_sid>100120,100140,100130</if_sid>
    <time>22:00 - 06:00</time>
    <description>Synology: AFTER-HOURS access - $(synology.user)@$(synology.srcip)</description>
    <group>after_hours,anomaly,</group>
  </rule>

  <rule id="100173" level="5">
    <if_sid>100120,100140,100130</if_sid>
    <weekday>saturday,sunday</weekday>
    <description>Synology: WEEKEND access - $(synology.user)@$(synology.srcip)</description>
    <group>weekend_access,anomaly,</group>
  </rule>

  <!-- Ransomware detection - Multiple deletes -->
  <rule id="100180" level="10" frequency="10" timeframe="60">
    <if_matched_sid>100151</if_matched_sid>
    <same_field>synology.srcip</same_field>
    <description>Synology: RANSOMWARE ALERT - Multiple file deletions from $(synology.srcip) ($(synology.user))</description>
    <group>ransomware_detection,critical,attack,</group>
    <mitre>
      <id>T1485</id>
      <id>T1486</id>
    </mitre>
  </rule>

  <!-- Data exfiltration - Multiple reads -->
  <rule id="100181" level="8" frequency="50" timeframe="300">
    <if_matched_sid>100152</if_matched_sid>
    <same_field>synology.srcip</same_field>
    <description>Synology: Possible DATA EXFILTRATION - Massive file reads from $(synology.srcip) ($(synology.user))</description>
    <group>data_exfiltration,anomaly,</group>
    <mitre>
      <id>T1039</id>
      <id>T1005</id>
    </mitre>
  </rule>

  <!-- Sensitive file access -->
  <rule id="100190" level="7">
    <if_sid>100140,100130</if_sid>
    <field name="synology.path">password|secret|credential|confidential|riservato|\.key$|\.pem$|\.pfx$</field>
    <description>Synology: SENSITIVE file access - $(synology.user)@$(synology.srcip) → $(synology.path)</description>
    <group>sensitive_data,compliance,</group>
  </rule>

  <!-- Administrative share access -->
  <rule id="100195" level="6">
    <if_sid>100120</if_sid>
    <field name="synology.share">^admin$|^backup$|^system$|^homes$</field>
    <description>Synology: ADMINISTRATIVE share access - $(synology.user)@$(synology.srcip) → $(synology.share)</description>
    <group>admin_access,privileged_access,</group>
  </rule>

</group>
