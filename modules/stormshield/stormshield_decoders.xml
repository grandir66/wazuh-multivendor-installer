<!-- Stormshield Firewall Decoders for Wazuh -->
<!-- https://github.com/grandir66/wazuh-multivendor-installer -->
<!-- Rule IDs: 100400-100499 -->

<!-- Main Stormshield decoder -->
<decoder name="stormshield">
  <prematch>id=firewall</prematch>
</decoder>

<!-- Alarm log type - most complete -->
<decoder name="stormshield-alarm">
  <parent>stormshield</parent>
  <prematch>logtype="alarm"</prematch>
  <regex> time="(\d+-\d+-\d+ \d+:\d+:\d+)" fw="(\S+)" \.+ pri=(\d+) \.+ src=(\d+\.\d+\.\d+\.\d+) srcport=(\d+)\.+ dst=(\d+\.\d+\.\d+\.\d+) dstport=(\d+)\.+ action=(\w+) msg="([^"]+)"\.+ alarmid=(\d+)</regex>
  <order>time, fw, pri, srcip, srcport, dstip, dstport, stormshield_action, msg, alarmid</order>
</decoder>

<!-- Connection/filter log type -->
<decoder name="stormshield-connection">
  <parent>stormshield</parent>
  <prematch>logtype="connection"</prematch>
  <regex> time="(\d+-\d+-\d+ \d+:\d+:\d+)" fw="(\S+)" \.+ pri=(\d+) \.+ src=(\d+\.\d+\.\d+\.\d+) srcport=(\d+)\.+ dst=(\d+\.\d+\.\d+\.\d+) dstport=(\d+)\.+ action=(\w+)</regex>
  <order>time, fw, pri, srcip, srcport, dstip, dstport, stormshield_action</order>
</decoder>

<!-- Filter log type -->
<decoder name="stormshield-filter">
  <parent>stormshield</parent>
  <prematch>logtype="filter"</prematch>
  <regex> time="(\d+-\d+-\d+ \d+:\d+:\d+)" fw="(\S+)" \.+ pri=(\d+) \.+ src=(\d+\.\d+\.\d+\.\d+) srcport=(\d+)\.+ dst=(\d+\.\d+\.\d+\.\d+) dstport=(\d+)\.+ action=(\w+)</regex>
  <order>time, fw, pri, srcip, srcport, dstip, dstport, stormshield_action</order>
</decoder>

<!-- Auth log type -->
<decoder name="stormshield-auth">
  <parent>stormshield</parent>
  <prematch>logtype="auth"</prematch>
  <regex> time="(\d+-\d+-\d+ \d+:\d+:\d+)" fw="(\S+)" \.+ user="([^"]+)"\.+ address=(\S+) \.+ error=(\d+)</regex>
  <order>time, fw, user, address, error</order>
</decoder>

<!-- Server/admin log type -->
<decoder name="stormshield-server">
  <parent>stormshield</parent>
  <prematch>logtype="server"</prematch>
  <regex> time="(\d+-\d+-\d+ \d+:\d+:\d+)" fw="(\S+)" \.+ user="([^"]+)"\.+ address=(\S+)</regex>
  <order>time, fw, user, address</order>
</decoder>

<!-- VPN log type -->
<decoder name="stormshield-vpn">
  <parent>stormshield</parent>
  <prematch>logtype="vpn"</prematch>
  <regex> time="(\d+-\d+-\d+ \d+:\d+:\d+)" fw="(\S+)" \.+ src=(\d+\.\d+\.\d+\.\d+)\.+ dst=(\d+\.\d+\.\d+\.\d+)</regex>
  <order>time, fw, srcip, dstip</order>
</decoder>

<!-- System log type -->
<decoder name="stormshield-system">
  <parent>stormshield</parent>
  <prematch>logtype="system"</prematch>
  <regex> time="(\d+-\d+-\d+ \d+:\d+:\d+)" fw="(\S+)" \.+ msg="([^"]+)"</regex>
  <order>time, fw, msg</order>
</decoder>

<!-- Fallback for any other stormshield log -->
<decoder name="stormshield-generic">
  <parent>stormshield</parent>
  <regex offset="after_parent"> time="(\d+-\d+-\d+ \d+:\d+:\d+)" fw="(\S+)"</regex>
  <order>time, fw</order>
</decoder>
