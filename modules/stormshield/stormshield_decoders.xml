<!-- Stormshield Firewall Decoders for Wazuh -->
<!-- https://github.com/grandir66/wazuh-multivendor-installer -->
<!-- Rule IDs: 100400-100499 -->
<!-- Works with rsyslog cleaned WELF format -->

<!-- Main Stormshield decoder - matches clean WELF format -->
<decoder name="stormshield">
  <prematch>^id=firewall</prematch>
</decoder>

<!-- Alarm logs -->
<decoder name="stormshield-alarm">
  <parent>stormshield</parent>
  <prematch>logtype="alarm"</prematch>
  <regex offset="after_parent"> time="(\S+ \S+)" fw="(\S+)" \.+ pri=(\d+) \.+ src=(\d+\.\d+\.\d+\.\d+) \.+ dst=(\d+\.\d+\.\d+\.\d+) \.+ action=(\w+) msg="(\.+)" \.+ alarmid=(\d+)</regex>
  <order>time,fw,pri,srcip,dstip,stormshield_action,msg,alarmid</order>
</decoder>

<!-- Connection logs -->
<decoder name="stormshield-connection">
  <parent>stormshield</parent>
  <prematch>logtype="connection"</prematch>
  <regex offset="after_parent"> time="(\S+ \S+)" fw="(\S+)" \.+ pri=(\d+) \.+ src=(\d+\.\d+\.\d+\.\d+) srcport=(\d+) \.+ dst=(\d+\.\d+\.\d+\.\d+) dstport=(\d+) \.+ action=(\w+)</regex>
  <order>time,fw,pri,srcip,srcport,dstip,dstport,stormshield_action</order>
</decoder>

<!-- Filter logs -->
<decoder name="stormshield-filter">
  <parent>stormshield</parent>
  <prematch>logtype="filter"</prematch>
  <regex offset="after_parent"> time="(\S+ \S+)" fw="(\S+)" \.+ pri=(\d+) \.+ src=(\d+\.\d+\.\d+\.\d+) srcport=(\d+) \.+ dst=(\d+\.\d+\.\d+\.\d+) dstport=(\d+) \.+ action=(\w+)</regex>
  <order>time,fw,pri,srcip,srcport,dstip,dstport,stormshield_action</order>
</decoder>

<!-- Auth logs -->
<decoder name="stormshield-auth">
  <parent>stormshield</parent>
  <prematch>logtype="auth"</prematch>
  <regex offset="after_parent"> time="(\S+ \S+)" fw="(\S+)" \.+ user="(\.+)" \.+ address=(\S+)</regex>
  <order>time,fw,user,address</order>
</decoder>

<!-- Server/admin logs -->
<decoder name="stormshield-server">
  <parent>stormshield</parent>
  <prematch>logtype="server"</prematch>
  <regex offset="after_parent"> time="(\S+ \S+)" fw="(\S+)" \.+ user="(\.+)" \.+ address=(\S+)</regex>
  <order>time,fw,user,address</order>
</decoder>

<!-- VPN logs -->
<decoder name="stormshield-vpn">
  <parent>stormshield</parent>
  <prematch>logtype="vpn"</prematch>
  <regex offset="after_parent"> time="(\S+ \S+)" fw="(\S+)" \.+ src=(\d+\.\d+\.\d+\.\d+) \.+ dst=(\d+\.\d+\.\d+\.\d+)</regex>
  <order>time,fw,srcip,dstip</order>
</decoder>

<!-- System logs -->
<decoder name="stormshield-system">
  <parent>stormshield</parent>
  <prematch>logtype="system"</prematch>
  <regex offset="after_parent"> time="(\S+ \S+)" fw="(\S+)" \.+ msg="(\.+)"</regex>
  <order>time,fw,msg</order>
</decoder>

<!-- Fallback - extract basic fields -->
<decoder name="stormshield-generic">
  <parent>stormshield</parent>
  <regex offset="after_parent"> time="(\S+ \S+)" fw="(\S+)"</regex>
  <order>time,fw</order>
</decoder>
