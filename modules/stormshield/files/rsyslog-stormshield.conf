# Stormshield Firewall rsyslog configuration
# Receives logs on UDP port 5514, converts to JSON for Wazuh

module(load="imudp")
input(type="imudp" port="5514" ruleset="stormshield")

# Output as JSON - parse key=value pairs
template(name="StormshieldJSON" type="list") {
    constant(value="{")
    # Extract each field using regex
    constant(value="\"time\":\"")
    property(name="msg" regex.expression="time=\"([^\"]+)\"" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"fw\":\"")
    property(name="msg" regex.expression="fw=\"([^\"]+)\"" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"pri\":\"")
    property(name="msg" regex.expression="pri=([0-9]+)" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"src\":\"")
    property(name="msg" regex.expression="src=([0-9.]+)" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"srcport\":\"")
    property(name="msg" regex.expression="srcport=([0-9]+)" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"dst\":\"")
    property(name="msg" regex.expression="dst=([0-9.]+)" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"dstport\":\"")
    property(name="msg" regex.expression="dstport=([0-9]+)" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"action\":\"")
    property(name="msg" regex.expression="action=([a-z]+)" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"msg\":\"")
    property(name="msg" regex.expression="msg=\"([^\"]+)\"" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"alarmid\":\"")
    property(name="msg" regex.expression="alarmid=([0-9]+)" regex.type="ERE" regex.submatch="1")
    constant(value="\",\"logtype\":\"")
    property(name="msg" regex.expression="logtype=\"([^\"]+)\"" regex.type="ERE" regex.submatch="1")
    constant(value="\"}\n")
}

ruleset(name="stormshield") {
    action(type="omfile" 
           file="/var/log/stormshield/stormshield.log" 
           template="StormshieldJSON"
           fileOwner="syslog"
           fileGroup="syslog"
           fileCreateMode="0644")
    stop
}
